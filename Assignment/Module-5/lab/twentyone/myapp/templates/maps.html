<!DOCTYPE html>
<html>
<head>
    <title>Google Maps Distance</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap" async defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { height: 400px; width: 100%; border-radius: 10px; }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="row">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h4>Distance Calculator</h4>
                <form method="POST">
                    {% csrf_token %}
                    <input type="text" name="origin" class="form-control mb-2" placeholder="Origin" required>
                    <input type="text" name="destination" class="form-control mb-2" placeholder="Destination" required>
                    <button type="submit" class="btn btn-primary w-100">Calculate & Show</button>
                </form>

                {% if distance %}
                <div class="mt-4 alert alert-info">
                    <p><strong>Distance:</strong> {{ distance }}</p>
                    <p><strong>Duration:</strong> {{ duration }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-8">
            <div id="map" class="shadow-sm"></div>
        </div>
    </div>
</div>

<script>
    function initMap() {
        // 1. Setup Default Map
        const myLatLng = { lat: 19.0760, lng: 72.8777 };
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: myLatLng,
        });

        // 2. Check if distance exists using a string comparison
        // We wrap the Django tag in quotes so JS sees it as a string
        const hasDistance = "{{ distance }}"; 

        if (hasDistance && hasDistance !== "None") {
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            directionsService.route({
                origin: "{{ origin_addr }}",
                destination: "{{ dest_addr }}",
                travelMode: google.maps.TravelMode.DRIVING,
            }, (response, status) => {
                if (status === "OK") {
                    directionsRenderer.setDirections(response);
                } else {
                    console.error("Directions request failed due to " + status);
                }
            });
        }
    }
</script>
</body>
</html>